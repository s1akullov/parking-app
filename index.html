<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–¥–µ –º–æ—è –º–∞—à–∏–Ω–∞?</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ú–æ—è –º–∞—à–∏–Ω–∞">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="–ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é –º–∞—à–∏–Ω—É –±—ã—Å—Ç—Ä–æ –∏ –ª–µ–≥–∫–æ">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%231a1a1a'/><text x='50%' y='50%' font-size='80' text-anchor='middle' dominant-baseline='middle' fill='white' font-family='system-ui'>P</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231a1a1a'/><text x='50%' y='50%' font-size='60' text-anchor='middle' dominant-baseline='middle' fill='white' font-family='system-ui'>P</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCT0LTQtSDQvNC+0Y8g0LzQsNGI0LjQvdCwPyIsCiAgInNob3J0X25hbWUiOiAi0JzQvtGPINC80LDRiNC40L3QsCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMxYTFhMWEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxOTIgMTkyJz48cmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzMWExYTFhJy8+PHRleHQgeD0nNTAlJyB5PSc1MCUnIGZvbnQtc2l6ZT0nMTAwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyBmaWxsPSd3aGl0ZScgZm9udC1mYW1pbHk9J3N5c3RlbS11aSc+UDwvdGV4dD48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInPjxyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyBmaWxsPSclMjMxYTFhMWEnLz48dGV4dCB4PSc1MCUnIHk9JzUwJScgZm9udC1zaXplPScyNjAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nc3lzdGVtLXVpJz5QPC90ZXh0Pjwvc3ZnPiIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #fff;
            height: 100vh;
            overflow: hidden;
            color: #1a1a1a;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 18px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            color: #1a1a1a;
        }

        .btn:hover {
            background: #f9f9f9;
            border-color: #d0d0d0;
        }

        .btn-primary {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        .btn-primary:hover {
            background: #333;
            border-color: #333;
        }

        .btn-danger {
            color: #dc2626;
            border-color: #dc2626;
        }

        .btn-danger:hover {
            background: #fef2f2;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 81px);
        }

        .sidebar {
            width: 380px;
            background: #fff;
            border-right: 1px solid #e5e5e5;
            overflow-y: auto;
            z-index: 500;
        }

        .map-container {
            flex: 1;
            position: relative;
            background: #f5f5f5;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .section {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
            font-size: 15px;
            letter-spacing: -0.2px;
        }

        .info-box {
            background: #f9f9f9;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
        }

        .info-label {
            font-size: 11px;
            color: #737373;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: #1a1a1a;
            font-weight: 500;
        }

        input[type="number"] {
            width: calc(50% - 6px);
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.2s;
            background: #fff;
        }

        input[type="number"]:first-of-type {
            margin-right: 12px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px dashed #d0d0d0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            background: #fafafa;
        }

        .photo-preview {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 12px;
            border: 1px solid #e5e5e5;
        }

        .timer-box {
            background: #1a1a1a;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 12px;
        }

        .timer-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .timer-value {
            font-size: 32px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
        }

        .alert-box {
            background: #dc2626;
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 12px;
            font-weight: 500;
            font-size: 14px;
        }

        .distance-box {
            background: #16a34a;
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 12px;
        }

        .distance-value {
            font-size: 24px;
            font-weight: 600;
            margin-top: 4px;
            letter-spacing: -0.5px;
        }

        .btn-full {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
        }

        .hidden {
            display: none;
        }

        .map-layers {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e5e5;
            z-index: 1000;
        }

        .map-layers-title {
            font-size: 11px;
            font-weight: 600;
            color: #737373;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 6px;
            border: 1px solid #e5e5e5;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-weight: 500;
        }

        .layer-button:last-child {
            margin-bottom: 0;
        }

        .layer-button:hover {
            background: #f9f9f9;
            border-color: #d0d0d0;
        }

        .layer-button.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e5e5;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-icon {
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        .legend-text {
            font-size: 13px;
            color: #525252;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #a3a3a3;
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: 16px;
            opacity: 0.3;
            font-weight: 700;
            color: #1a1a1a;
        }

        .empty-state h3 {
            font-size: 16px;
            color: #525252;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 14px;
            line-height: 1.5;
            color: #a3a3a3;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #f0f0f0;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #1a1a1a;
        }

        .loading-subtext {
            font-size: 13px;
            color: #a3a3a3;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                height: auto;
                max-height: 50vh;
                z-index: 1000;
            }
            
            .header {
                padding: 16px 20px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .map-layers {
                top: 10px;
                right: 10px;
            }

            .map-legend {
                bottom: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã</div>
        <div class="loading-subtext">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ</div>
    </div>

    <div class="header">
        <h1>–ì–¥–µ –º–æ—è –º–∞—à–∏–Ω–∞?</h1>
        <div class="header-buttons">
            <button class="btn btn-primary" id="saveBtn" onclick="saveParking()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É</button>
            <button class="btn btn-danger hidden" id="clearBtn" onclick="clearParking()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div id="emptyState" class="section">
                <div class="empty-state">
                    <div class="empty-state-icon">P</div>
                    <h3>–ü–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</p>
                </div>
            </div>

            <div id="parkingInfo" class="hidden">
                <div class="section">
                    <div class="section-title">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                    <div class="info-box">
                        <div class="info-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–∞—à–∏–Ω—ã</div>
                        <div class="info-value" id="carCoords">‚Äî</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                        <div class="info-value" id="myCoords">‚Äî</div>
                    </div>
                    <div class="distance-box" id="distanceBox">
                        <div class="info-label" style="color: white; opacity: 0.8; font-size: 11px;">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                        <div class="distance-value" id="distanceValue">‚Äî</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">–û–ø–ª–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</div>
                    <input type="number" id="hoursInput" placeholder="–ß–∞—Å—ã" min="0" max="23" value="0">
                    <input type="number" id="minutesInput" placeholder="–ú–∏–Ω—É—Ç—ã" min="0" max="59" value="0">
                    <button class="btn btn-full" onclick="updateTimer()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä</button>
                    <div id="timerBox" class="hidden"></div>
                    <div id="alertBox" class="hidden"></div>
                </div>

                <div class="section">
                    <div class="section-title">–§–æ—Ç–æ –ø–∞—Ä–∫–æ–≤–∫–∏</div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="updatePhoto()">
                    <img id="photoPreview" class="photo-preview hidden" alt="–§–æ—Ç–æ –ø–∞—Ä–∫–æ–≤–∫–∏">
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ª–æ—ë–≤ –∫–∞—Ä—Ç—ã -->
            <div class="map-layers">
                <div class="map-layers-title">–¢–∏–ø –∫–∞—Ä—Ç—ã</div>
                <button class="layer-button active" onclick="changeMapLayer('light')" id="layerLight">–°–≤–µ—Ç–ª–∞—è</button>
                <button class="layer-button" onclick="changeMapLayer('standard')" id="layerStandard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                <button class="layer-button" onclick="changeMapLayer('satellite')" id="layerSatellite">–°–ø—É—Ç–Ω–∏–∫</button>
                <button class="layer-button" onclick="changeMapLayer('dark')" id="layerDark">–¢—ë–º–Ω–∞—è</button>
            </div>
            
            <div class="map-legend">
                <div class="legend-item">
                    <span class="legend-icon" style="width: 12px; height: 12px; background: #dc2626; border-radius: 50%; display: inline-block;"></span>
                    <span class="legend-text">–ú–∞—à–∏–Ω–∞</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon" style="width: 12px; height: 12px; background: #1a1a1a; border-radius: 50%; display: inline-block;"></span>
                    <span class="legend-text">–í—ã</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let carMarker;
        let userMarker;
        let userCircle;
        let routeLine;
        let currentLayer;
        let parkingData = {
            carLat: null,
            carLng: null,
            photo: null,
            endTime: null
        };
        let userPosition = null;
        let timerInterval = null;
        let watchId = null;

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—ë–≤ –∫–∞—Ä—Ç—ã
        const mapLayers = {
            light: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: ''
            },
            standard: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: ''
            },
            satellite: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: ''
            },
            dark: {
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                attribution: ''
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –†–æ—Å—Ç–æ–≤–µ-–Ω–∞-–î–æ–Ω—É
        function initMap() {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –†–æ—Å—Ç–æ–≤–∞-–Ω–∞-–î–æ–Ω—É
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([47.2357, 39.7015], 13);

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ—Ç–ª—É—é –∫–∞—Ä—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            currentLayer = L.tileLayer(mapLayers.light.url, {
                attribution: mapLayers.light.attribution,
                maxZoom: 19
            }).addTo(map);

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            startWatchingPosition();
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Å–ª–æ—è –∫–∞—Ä—Ç—ã
        function changeMapLayer(layerType) {
            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
            currentLayer = L.tileLayer(mapLayers[layerType].url, {
                attribution: mapLayers[layerType].attribution,
                maxZoom: 19
            }).addTo(map);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.layer-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('layer' + layerType.charAt(0).toUpperCase() + layerType.slice(1)).classList.add('active');
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function startWatchingPosition() {
            if (navigator.geolocation) {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateUserMarker();
                        updateDistance();
                        updateMyCoords();
                        
                        // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
                        watchId = navigator.geolocation.watchPosition(
                            function(position) {
                                userPosition = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                updateUserMarker();
                                updateDistance();
                                updateMyCoords();
                            },
                            function(error) {
                                console.error('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:', error);
                            },
                            {
                                enableHighAccuracy: true,
                                maximumAge: 30000,
                                timeout: 27000
                            }
                        );
                    },
                    function(error) {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'üö´ –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω.\n\n–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é:\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ\n2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é\n3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'üì° –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –í–∫–ª—é—á–µ–Ω –ª–∏ GPS/Wi-Fi\n‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç–µ—Å—å –ª–∏ –≤—ã –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏\n‚Ä¢ –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ç–∏';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‚è±Ô∏è –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É\n‚Ä¢ –í—ã–π—Ç–∏ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                                break;
                            default:
                                errorMessage = '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                        }
                        alert(errorMessage);
                        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', error.code, '–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 10000
                    }
                );
            } else {
                alert('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari).');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserMarker() {
            if (!userPosition) return;

            if (userMarker) {
                userMarker.setLatLng([userPosition.lat, userPosition.lng]);
            } else {
                const userIcon = L.divIcon({
                    html: '<div style="width: 14px; height: 14px; background: #1a1a1a; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                userMarker = L.marker([userPosition.lat, userPosition.lng], {icon: userIcon}).addTo(map);
                userMarker.bindPopup('–í—ã –∑–¥–µ—Å—å');
            }

            if (userCircle) {
                userCircle.setLatLng([userPosition.lat, userPosition.lng]);
            } else {
                userCircle = L.circle([userPosition.lat, userPosition.lng], {
                    color: '#1a1a1a',
                    fillColor: '#1a1a1a',
                    fillOpacity: 0.1,
                    radius: 20,
                    weight: 1
                }).addTo(map);
            }

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –ø–∞—Ä–∫–æ–≤–∫–∏)
            if (!parkingData.carLat) {
                map.setView([userPosition.lat, userPosition.lng], 15);
            }

            updateRoute();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏
        function saveParking() {
            if (!userPosition) {
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.');
                return;
            }

            parkingData.carLat = userPosition.lat;
            parkingData.carLng = userPosition.lng;

            // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä –º–∞—à–∏–Ω—ã
            if (carMarker) {
                carMarker.setLatLng([parkingData.carLat, parkingData.carLng]);
            } else {
                const carIcon = L.divIcon({
                    html: '<div style="width: 16px; height: 16px; background: #dc2626; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    className: 'custom-marker',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                });
                carMarker = L.marker([parkingData.carLat, parkingData.carLng], {icon: carIcon}).addTo(map);
                carMarker.bindPopup('–í–∞—à–∞ –º–∞—à–∏–Ω–∞');
            }

            saveParkingData();
            showParkingInfo();
            updateCarCoords();
            updateDistance();
            updateRoute();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            if (userPosition) {
                const bounds = L.latLngBounds(
                    [parkingData.carLat, parkingData.carLng],
                    [userPosition.lat, userPosition.lng]
                );
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function updateRoute() {
            if (!parkingData.carLat || !userPosition) return;

            if (routeLine) {
                map.removeLayer(routeLine);
            }

            routeLine = L.polyline([
                [parkingData.carLat, parkingData.carLng],
                [userPosition.lat, userPosition.lng]
            ], {
                color: '#1a1a1a',
                weight: 2,
                opacity: 0.6,
                dashArray: '8, 8'
            }).addTo(map);
        }

        // –†–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        function updateDistance() {
            if (!parkingData.carLat || !userPosition) return;

            const distance = calculateDistance(
                parkingData.carLat,
                parkingData.carLng,
                userPosition.lat,
                userPosition.lng
            );

            let distanceText;
            if (distance < 1000) {
                distanceText = Math.round(distance) + ' –º';
            } else {
                distanceText = (distance / 1000).toFixed(2) + ' –∫–º';
            }

            document.getElementById('distanceValue').textContent = distanceText;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function updateCarCoords() {
            if (parkingData.carLat && parkingData.carLng) {
                document.getElementById('carCoords').textContent = 
                    `${parkingData.carLat.toFixed(6)}, ${parkingData.carLng.toFixed(6)}`;
            }
        }

        function updateMyCoords() {
            if (userPosition) {
                document.getElementById('myCoords').textContent = 
                    `${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}`;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä–∫–æ–≤–∫–µ
        function showParkingInfo() {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('parkingInfo').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('clearBtn').classList.remove('hidden');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        function updateTimer() {
            const hours = parseInt(document.getElementById('hoursInput').value) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value) || 0;

            if (hours === 0 && minutes === 0) {
                document.getElementById('timerBox').classList.add('hidden');
                document.getElementById('alertBox').classList.add('hidden');
                parkingData.endTime = null;
                saveParkingData();
                return;
            }

            const now = new Date();
            parkingData.endTime = now.getTime() + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
            saveParkingData();
            startTimer();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        function startTimer() {
            const timerBox = document.getElementById('timerBox');
            const alertBox = document.getElementById('alertBox');
            
            timerBox.innerHTML = '<div class="timer-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</div><div class="timer-value" id="timeRemaining"></div>';
            timerBox.classList.remove('hidden');
            alertBox.classList.add('hidden');

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(function() {
                const now = new Date().getTime();
                const remaining = parkingData.endTime - now;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerBox.classList.add('hidden');
                    alertBox.innerHTML = '‚ö†Ô∏è –í—Ä–µ–º—è –ø–∞—Ä–∫–æ–≤–∫–∏ –∏—Å—Ç–µ–∫–ª–æ';
                    alertBox.classList.remove('hidden');
                    alertBox.className = 'alert-box';
                    return;
                }

                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                document.getElementById('timeRemaining').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
        function updatePhoto() {
            const file = document.getElementById('photoInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parkingData.photo = e.target.result;
                    const preview = document.getElementById('photoPreview');
                    preview.src = parkingData.photo;
                    preview.classList.remove('hidden');
                    saveParkingData();
                };
                reader.readAsDataURL(file);
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä–∫–æ–≤–∫–∏
        function clearParking() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–∞—Ä–∫–æ–≤–∫–µ?')) return;

            parkingData = {
                carLat: null,
                carLng: null,
                photo: null,
                endTime: null
            };

            if (carMarker) {
                map.removeLayer(carMarker);
                carMarker = null;
            }

            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('parkingInfo').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('clearBtn').classList.add('hidden');
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoInput').value = '';
            document.getElementById('hoursInput').value = '0';
            document.getElementById('minutesInput').value = '0';

            deleteParkingData();
        }

        // –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
        function saveParkingData() {
            sessionStorage.setItem('parkingData', JSON.stringify(parkingData));
        }

        function loadParkingData() {
            const data = sessionStorage.getItem('parkingData');
            if (data) {
                parkingData = JSON.parse(data);
                
                if (parkingData.carLat && parkingData.carLng) {
                    showParkingInfo();
                    
                    const carIcon = L.divIcon({
                        html: '<div style="width: 16px; height: 16px; background: #dc2626; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        className: 'custom-marker',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    carMarker = L.marker([parkingData.carLat, parkingData.carLng], {icon: carIcon}).addTo(map);
                    carMarker.bindPopup('–í–∞—à–∞ –º–∞—à–∏–Ω–∞');
                    
                    updateCarCoords();
                    updateDistance();
                    updateRoute();
                    
                    if (parkingData.photo) {
                        document.getElementById('photoPreview').src = parkingData.photo;
                        document.getElementById('photoPreview').classList.remove('hidden');
                    }
                    
                    if (parkingData.endTime) {
                        const now = new Date().getTime();
                        if (parkingData.endTime > now) {
                            startTimer();
                        } else {
                            const alertBox = document.getElementById('alertBox');
                            alertBox.innerHTML = '‚ö†Ô∏è –í—Ä–µ–º—è –ø–∞—Ä–∫–æ–≤–∫–∏ –∏—Å—Ç–µ–∫–ª–æ';
                            alertBox.classList.remove('hidden');
                            alertBox.className = 'alert-box';
                        }
                    }
                }
            }
        }

        function deleteParkingData() {
            sessionStorage.removeItem('parkingData');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            // –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Leaflet
            if (typeof L !== 'undefined') {
                initMap();
                loadParkingData();
                hideLoading();
            } else {
                // –ï—Å–ª–∏ Leaflet –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –∂–¥—ë–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                let attempts = 0;
                const maxAttempts = 5;
                
                const checkLeaflet = setInterval(function() {
                    attempts++;
                    
                    if (typeof L !== 'undefined') {
                        clearInterval(checkLeaflet);
                        initMap();
                        loadParkingData();
                        hideLoading();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkLeaflet);
                        showLoadingError();
                    }
                }, 500);
            }
        };

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.opacity = '0';
            setTimeout(function() {
                overlay.style.display = 'none';
            }, 300);
        }

        function showLoadingError() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <div class="loading-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</div>
                    <div class="loading-subtext" style="margin-bottom: 20px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</div>
                    <button onclick="location.reload()" style="padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
