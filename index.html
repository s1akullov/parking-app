<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Где моя машина?</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Моя машина">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Найдите свою машину быстро и легко">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #fff;
            height: 100vh;
            overflow: hidden;
            color: #1a1a1a;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 18px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: #fff;
            color: #1a1a1a;
        }

        .btn-primary {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        .btn-danger {
            color: #dc2626;
            border-color: #dc2626;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 81px);
        }

        .sidebar {
            width: 380px;
            background: #fff;
            border-right: 1px solid #e5e5e5;
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .section {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #a3a3a3;
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: 16px;
            opacity: 0.3;
            font-weight: 700;
        }

        .info-box {
            background: #f9f9f9;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
        }

        .info-label {
            font-size: 11px;
            color: #737373;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
        }

        .distance-box {
            background: #16a34a;
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 12px;
        }

        .distance-value {
            font-size: 24px;
            font-weight: 600;
            margin-top: 4px;
        }

        .btn-full {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
        }

        .hidden {
            display: none;
        }

        input[type="number"], textarea {
            width: calc(50% - 6px);
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px dashed #d0d0d0;
            border-radius: 8px;
            font-size: 13px;
        }

        .photo-preview {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 12px;
        }

        .note-display {
            background: #fff9e6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #f0f0f0;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>Загрузка карты...</div>
    </div>

    <div class="header">
        <h1>Где моя машина?</h1>
        <div class="header-buttons">
            <button class="btn btn-primary" id="saveBtn" onclick="saveParking()">Сохранить парковку</button>
            <button class="btn btn-danger hidden" id="clearBtn" onclick="clearParking()">Очистить</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div id="emptyState" class="section">
                <div class="empty-state">
                    <div class="empty-state-icon">P</div>
                    <h3>Парковка не сохранена</h3>
                    <p>Нажмите кнопку выше, чтобы запомнить местоположение автомобиля</p>
                </div>
            </div>

            <div id="parkingInfo" class="hidden">
                <div class="section">
                    <div class="section-title">Местоположение</div>
                    <div class="info-box">
                        <div class="info-label">Координаты машины</div>
                        <div class="info-value" id="carCoords">—</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Моё местоположение</div>
                        <div class="info-value" id="myCoords">—</div>
                    </div>
                    <div class="distance-box">
                        <div class="info-label" style="color: white; opacity: 0.8;">Расстояние</div>
                        <div class="distance-value" id="distanceValue">—</div>
                    </div>
                    <button class="btn btn-full" onclick="shareLocation()">Поделиться местом</button>
                </div>

                <div class="section">
                    <div class="section-title">Быстрая заметка</div>
                    <textarea id="noteInput" placeholder="Уровень 2, место 45..."></textarea>
                    <button class="btn btn-full" onclick="saveNote()">Сохранить</button>
                    <div id="noteDisplay" class="note-display hidden"></div>
                </div>

                <div class="section">
                    <div class="section-title">Фото парковки</div>
                    <input type="file" id="photoInput" accept="image/*" onchange="updatePhoto()">
                    <img id="photoPreview" class="photo-preview hidden">
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map, carMarker, userMarker, userCircle, routeLine;
        let parkingData = { carLat: null, carLng: null, photo: null, note: '' };
        let userPosition = null;

        function initMap() {
            map = L.map('map', { attributionControl: false }).setView([47.2357, 39.7015], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            startWatchingPosition();
        }

        function startWatchingPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                        updateUserMarker();
                    },
                    error => alert('Не удалось получить геолокацию')
                );
            }
        }

        function updateUserMarker() {
            if (!userPosition) return;
            
            const icon = L.divIcon({
                html: '<div style="width: 14px; height: 14px; background: #1a1a1a; border: 3px solid white; border-radius: 50%;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            if (userMarker) {
                userMarker.setLatLng([userPosition.lat, userPosition.lng]);
            } else {
                userMarker = L.marker([userPosition.lat, userPosition.lng], {icon}).addTo(map);
            }
            
            if (!parkingData.carLat) map.setView([userPosition.lat, userPosition.lng], 15);
            updateDistance();
        }

        function saveParking() {
            if (!userPosition) return alert('Сначала определите местоположение');
            
            parkingData.carLat = userPosition.lat;
            parkingData.carLng = userPosition.lng;
            
            const icon = L.divIcon({
                html: '<div style="width: 16px; height: 16px; background: #dc2626; border: 3px solid white; border-radius: 50%;"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            
            if (carMarker) {
                carMarker.setLatLng([parkingData.carLat, parkingData.carLng]);
            } else {
                carMarker = L.marker([parkingData.carLat, parkingData.carLng], {icon}).addTo(map);
            }
            
            sessionStorage.setItem('parkingData', JSON.stringify(parkingData));
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('parkingInfo').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('clearBtn').classList.remove('hidden');
            
            updateCoords();
            updateDistance();
        }

        function updateCoords() {
            if (parkingData.carLat) {
                document.getElementById('carCoords').textContent = 
                    `${parkingData.carLat.toFixed(6)}, ${parkingData.carLng.toFixed(6)}`;
            }
            if (userPosition) {
                document.getElementById('myCoords').textContent = 
                    `${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}`;
            }
        }

        function updateDistance() {
            if (!parkingData.carLat || !userPosition) return;
            
            const R = 6371e3;
            const φ1 = parkingData.carLat * Math.PI / 180;
            const φ2 = userPosition.lat * Math.PI / 180;
            const Δφ = (userPosition.lat - parkingData.carLat) * Math.PI / 180;
            const Δλ = (userPosition.lng - parkingData.carLng) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            document.getElementById('distanceValue').textContent = 
                distance < 1000 ? Math.round(distance) + ' м' : (distance / 1000).toFixed(2) + ' км';
        }

        function saveNote() {
            const note = document.getElementById('noteInput').value.trim();
            if (note) {
                parkingData.note = note;
                sessionStorage.setItem('parkingData', JSON.stringify(parkingData));
                const display = document.getElementById('noteDisplay');
                display.textContent = note;
                display.classList.remove('hidden');
            }
        }

        function updatePhoto() {
            const file = document.getElementById('photoInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    parkingData.photo = e.target.result;
                    document.getElementById('photoPreview').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    sessionStorage.setItem('parkingData', JSON.stringify(parkingData));
                };
                reader.readAsDataURL(file);
            }
        }

        function shareLocation() {
            if (!parkingData.carLat) return;
            const url = `https://www.google.com/maps?q=${parkingData.carLat},${parkingData.carLng}`;
            if (navigator.share) {
                navigator.share({ title: 'Моя машина', url });
            } else {
                navigator.clipboard.writeText(url).then(() => alert('Ссылка скопирована!'));
            }
        }

        function clearParking() {
            if (!confirm('Удалить данные?')) return;
            parkingData = { carLat: null, carLng: null, photo: null, note: '' };
            if (carMarker) map.removeLayer(carMarker);
            sessionStorage.removeItem('parkingData');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('parkingInfo').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('clearBtn').classList.add('hidden');
        }

        window.onload = () => {
            if (typeof L !== 'undefined') {
                initMap();
                document.getElementById('loadingOverlay').style.display = 'none';
                
                const saved = sessionStorage.getItem('parkingData');
                if (saved) {
                    parkingData = JSON.parse(saved);
                    if (parkingData.carLat) {
                        const icon = L.divIcon({
                            html: '<div style="width: 16px; height: 16px; background: #dc2626; border: 3px solid white; border-radius: 50%;"></div>',
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        });
                        carMarker = L.marker([parkingData.carLat, parkingData.carLng], {icon}).addTo(map);
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('parkingInfo').classList.remove('hidden');
                        document.getElementById('saveBtn').classList.add('hidden');
                        document.getElementById('clearBtn').classList.remove('hidden');
                        updateCoords();
                        
                        if (parkingData.note) {
                            document.getElementById('noteInput').value = parkingData.note;
                            document.getElementById('noteDisplay').textContent = parkingData.note;
                            document.getElementById('noteDisplay').classList.remove('hidden');
                        }
                        if (parkingData.photo) {
                            document.getElementById('photoPreview').src = parkingData.photo;
                            document.getElementById('photoPreview').classList.remove('hidden');
                        }
                    }
                }
            }
        };
    </script>
</body>
</html>
